<!DOCTYPE html>
<html>
<head>
  <title>Event QR Scanner</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body style="font-family: Arial; text-align: center; padding: 20px;">
  <h2>ğŸ“· Scan Your Event QR</h2>
  <div id="reader" style="width: 500px; height: 400px;"></div>
  <div id="status" style="margin-top: 20px;"></div>

  <script>
  const DEPLOYED_GAS_URL = "https://script.google.com/macros/s/AKfycby0bnfKtwfFkYQvWcu2n6JOpxdqZAwyRfJX5_ckVriTSsNBIjIIhZrdEtpf7fSrrrGcQg/exec";
  let alreadyScanned = false;

  function onScanSuccess(decodedText) {
  if (alreadyScanned) return;
  alreadyScanned = true;

  console.log("âœ… QR scanned:", decodedText);
  
  // Hide scanner immediately
  document.getElementById("reader").style.display = "none";

  document.getElementById("status").innerHTML = "ğŸ” Validating...";

  const uuidMatch = decodedText.match(/[a-f0-9\-]{36}/);
  if (uuidMatch) {
    const uuid = uuidMatch[0];
    const fullURL = `${DEPLOYED_GAS_URL}?uuid=${uuid}`;
    console.log("ğŸŒ Fetching:", fullURL);

    fetch(fullURL)
      .then(res => res.text())
      .then(html => {
        console.log("âœ… Validation response received");

        // Show response nicely
        const iframe = document.createElement("iframe");
        iframe.style.width = "100%";
        iframe.style.height = "600px";
        iframe.style.border = "none";
        iframe.srcdoc = html;

        const statusDiv = document.getElementById("status");
        statusDiv.innerHTML = "";
        statusDiv.appendChild(iframe);
      })
      .catch(err => {
        console.error("âŒ Fetch failed:", err);
        document.getElementById("status").innerHTML = "âŒ Server error.";
        alreadyScanned = false;
      });
  } else {
    console.warn("âš ï¸ No UUID match in QR:", decodedText);
    document.getElementById("status").innerHTML = "âŒ Invalid QR format.";
    alreadyScanned = false;
    document.getElementById("reader").style.display = "block"; // Show scanner again
  }
}


  function onScanFailure(error) {
    // Optional: console.log("No QR detected", error);
  }

  console.log("ğŸ“¸ Starting QR scanner...");
  const html5QrCode = new Html5Qrcode("reader");
  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: { width: 250, height: 250 } },
    onScanSuccess,
    onScanFailure
  ).catch(err => {
    console.error("âŒ Camera error:", err);
    document.getElementById("status").innerHTML = "âŒ Camera access failed: " + err;
  });
</script>
</body>
</html>
